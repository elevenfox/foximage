<?php

$dirs = <<<EOF
尤美_M梦baby《一日女友》-Vol.083-写真集-19P-
尤美_M梦baby《俄罗斯雄起》-Vol.020-写真集-12P-
尤美_M梦baby《倾城丽人》-Vol.100-写真集-5P-
尤美_M梦baby《女友の角色扮演》-Vol.043-写真集-18P-
尤美_M梦baby《情欲浴室》-Vol.090-写真集-5P-
尤美_M梦baby《蕾丝女神》-Vol.039-写真集-27P-
尤美_亿美《粉红制服诱惑》-Vol.002-写真集-18P-
尤美_付艺轩《粉嫩俏佳人》-Vol.007-写真集-25P-
尤美_何嘉颖《真空诱惑》-Vol.070-写真集-17P-
尤美_何嘉颖《绝色佳丽》-Vol.055-写真集-18P-
尤美_十三姨《爆乳娇娘》-NO.097-写真集-5P-
尤美_卓娅祺《女神の内衣秀》-Vol.081-写真集-19P-
尤美_卓娅祺《恋与卓娅祺》-Vol.050-写真集-28P-
尤美_卓娅祺《真空厨娘》-Vol.063-写真集-30P-
尤美_卓娅祺《精灵尤物》-Vol.088-写真集-5P-
尤美_叶子《性感猫娘》-Vol.064-写真集-20P-
尤美_叶子《黑丝御姐》-Vol.072-写真集-5P-
尤美_咪咪《天生尤物》-Vol.092-写真集-5P-
尤美_咪咪《玲珑娇妻咪》-Vol.102-写真集-5P-
尤美_喵星人《可爱の女友》-Vol.040-写真集-25P-
尤美_喵星人《娇艳の小球迷》-Vol.016-写真集-18P-
尤美_喵星人《猫系女友》-Vol.032-写真集-17P-
尤美_团团《居家少妇》-Vol.041-写真集-23P-
尤美_团团《睡美人》-Vol.031-写真集-24P-
尤美_团团《雄鹰之恋》-Vol.018-写真集-8P-
尤美_夏妍《蕾丝惑人心》-Vol.005-写真集-22P-
尤美_夜夜《闺房私恋》-Vol.003-写真集-22P-
尤美_大萱萱《球场童话》-Vol.029-写真集-20P-
尤美_大萱萱《黑丝女仆》-Vol.038-写真集-5P-
尤美_小KK《绝美人妻》-Vol.076-写真集-29P-
尤美_小热巴《东欧铁骑》-Vol.022-写真集-12P-
尤美_小热巴《旗袍少妇》-Vol.036-写真集-16P-
尤美_小热巴《红粉佳人》-Vol.079-写真集-26P-
尤美_小热巴《黑丝尤物》-Vol.061-写真集-28P-
尤美_尹菲《世界杯好球》-Vol.013-写真集-15P-
尤美_尹菲《夜芳菲》-Vol.085-写真集-22P-
尤美_尹菲《燃情少妇》-Vol.065-写真集-5P-
尤美_尹菲《磨人の妖精》-Vol.049-写真集-16P-
尤美_尹菲《野蛮生长》-Vol.030-写真集-15P-
尤美_尹菲《随性の诱惑》-Vol.089-写真集-5P-
尤美_张雨萌《真空御姐》-Vol.101-写真集-5P-
尤美_易阳《办公室的诱惑》-Vol.010-写真集-5P-
尤美_易阳《铁血尤物》-Vol.028-写真集-22P-
尤美_易阳《霸屏乳神》-Vol.054-写真集-28P-
尤美_林一《御姐风情》-Vol.091-写真集-5P-
尤美_林一《邻居姐姐》-Vol.001-写真集-30P-
尤美_柠檬《妖精-amp-amp-花蕊》-Vol.004-写真集-21P-
尤美_柠檬《水嫩柠檬》-Vol.062-写真集-30P-
尤美_模特Ada《艳遇桃花源》-Vol.009-写真集-25P-
尤美_模特MI《叛逆青春期》-Vol.006-写真集-25P-
尤美_沈蜜桃《吃鸡の蜜桃》-Vol.051-写真集-20P-
尤美_洛洛-《白玉酥胸》-NO.096-写真集-5P-
尤美_温心怡《捆绑の诱惑》-Vol.035-写真集-30P-
尤美_温心怡《激情法兰西》-Vol.015-写真集-30P-
尤美_温心怡《绑缚の情趣》-Vol.077-写真集-25P-
尤美_爱丽莎《初夏の小短裙》-Vol.011-写真集-28P-
尤美_爱丽莎《比利时狂欢》-Vol.014-写真集-8P-
尤美_王雨纯《美酒雨纯》-Vol.044-写真集-27P-
尤美_王雨纯《荷尔蒙军团》-Vol.025-写真集-20P-
尤美_王雨纯《闺房私雨》-Vol.099-写真集-5P-
尤美_筱慧《佳人如棕》-Vol.024-写真集-21P-
尤美_筱慧《勾魂女秘书》-Vol.067-写真集-19P-
尤美_筱慧《清醇尤物》-Vol.021-写真集-13P-
尤美_筱慧《玉女湿身》-Vol.080-写真集-5P-
尤美_筱慧《私房尤物》-Vol.037-写真集-22P-
尤美_绯月樱-Cherry《动情の夏天》-Vol.033-写真集-30P-
尤美_绯月樱-Cherry《学妹の情窦初开》-Vol.066-写真集-23P-
尤美_绯月樱-Cherry《巨臀妖精》-Vol.017-写真集-25P-
尤美_绯月樱-Cherry《情迷万圣节》-Vol.074-写真集-5P-
尤美_绯月樱-Cherry《浴室俏佳人》-Vol.045-写真集-20P-
尤美_绯月樱-Cherry《纯白蕾丝》-Vol.027-写真集-30P-
尤美_绯月樱-Cherry《绝色尤物》-Vol.053-写真集-17P-
尤美_艺轩-amp-amp-喵星人《女女情深》-Vol.047-写真集-29P-
尤美_艺轩-amp-amp-喵星人《山中奇遇》-Vol.048-写真集-19P-
尤美_艺轩-amp-amp-喵星人《洞房花烛》-Vol.046-写真集-27P-
尤美_艺轩《御姐范蕾丝》-Vol.084-写真集-20P-
尤美_艺轩《樱花武者》-Vol.023-写真集-23P-
尤美_艺轩《欲火燃情美少妇》-Vol.068-写真集-26P-
尤美_艺轩《花仙私语》-Vol.026-写真集-22P-
尤美_艾小青《倾城佳人》-NO.094-写真集-5P-
尤美_艾小青《尤物春心》-Vol.059-写真集-5P-
尤美_苏苏《媚娘进行时》-Vol.056-写真集-25P-
尤美_陆梓琪《少女多情》-Vol.078-写真集-20P-
尤美_陈圆圆-amp-amp-何嘉颖《圣诞夜，春意生》-NO.095-写真集-5P-
尤美_陈圆圆《情迷健身房》-Vol.082-写真集-27P-
尤美_陈圆圆《美乳佳人》-Vol.073-写真集-28P-
尤美_陈宇曦《初恋私房》-Vol.060-写真集-26P-
尤美_露露小喵《风情美人》-Vol.093-写真集-5P-
尤美_黄依婷《春色挡不住》-Vol.008-写真集-25P-
尤美_黄依婷《诱惑的艺术》-Vol.052-写真集-25P-
尤美_黄楽然《皮鞭女王》-Vol.034-写真集-23P-
尤美_黄楽然《致命の黄玫瑰》-Vol.019-写真集-21P-
尤美_黄金宝儿《闪光少女》-NO.098-写真集-5P-
EOF;

// 重命名文件夹用tujigu的名字，copy desc 和 tags，重命名thumbnail
if (!function_exists('str_starts_with')) {
    function str_starts_with($haystack, $needle) {
        return (string)$needle !== '' && strncmp($haystack, $needle, strlen($needle)) === 0;
    }
}

function find_between($str, $startDelimiter, $endDelimiter) {
    $contents = array();
    $startDelimiterLength = strlen($startDelimiter);
    $endDelimiterLength = strlen($endDelimiter);
    $startFrom = $contentStart = $contentEnd = 0;
    while (false !== ($contentStart = strpos($str, $startDelimiter, $startFrom))) {
      $contentStart += $startDelimiterLength;
      $contentEnd = strpos($str, $endDelimiter, $contentStart);
      if (false === $contentEnd) {
        break;
      }
      $contents[] = substr($str, $contentStart, $contentEnd - $contentStart);
      $startFrom = $contentEnd + $endDelimiterLength;
    }
  
    return $contents;
}

$folder_full_path = isset($argv[1]) ? $argv[1] : null;

if(empty($folder_full_path)) {
    echo "---- Must have a full folder path as the param! \n";
    exit;
}

$dryrun = 0;
$org_name = '尤美';
$org_name_en = 'YouMei';

$scan = scandir($folder_full_path);
foreach($scan as $folder_name) {
   if (is_dir("$folder_full_path/$folder_name") && $folder_name!='.' && $folder_name!='..') {
        $the_full_path = "$folder_full_path/$folder_name";
        echo "------------------------- \n";
        echo "-- Current folder: $folder_name \n";
        // Get cuurent folder vol number
        $l_folder_name = strtolower($folder_name);
        // $v_arr = explode(' ',$l_folder_name);
        $v_arr = explode('-',$l_folder_name);
        $vol = $v_arr[1];

        $vol = str_replace('no.', '', $vol);
        // Go to origin path to get folder name with the same vol num
        $origin = getOriginFolderByVol($vol);
        echo print_r($origin,1) . "\n"; 
        
        if(!empty($origin)) {
            // copy desc.txt and tags.txt from origin folder
            $desc_str = file_get_contents($origin['full_path'] . "/desc.txt");
            $desc_str = str_replace(' 生日','生日', $desc_str);
            $pos = strpos($desc_str, '生日');
            if($pos !== false) {
                $c = $desc_str[$pos-1];
                if ($c != "\n" && $c != "\rn" && $c != "\r") {
                    $desc_str = str_replace('生日',"\n生日", $desc_str);
                }
            }
            $desc_str = str_replace(' 罩杯','罩杯', $desc_str);
            $pos = strpos($desc_str, '罩杯');
            if($pos !== false) {
                $c = $desc_str[$pos-1];
                if ($c != "\n" && $c != "\rn" && $c != "\r") {
                    $desc_str = str_replace('罩杯',"\n罩杯", $desc_str);
                }
            }
            echo "Processing " . $the_full_path . "/desc.txt \n";
            if(!$dryrun) file_put_contents($the_full_path.'/desc.txt', $desc_str);
            
            // copy($origin['full_path'] . "/tags.txt", $the_full_path . "/tags.txt");

            // Gen new tags
            $tags_str = file_get_contents($origin['full_path'] . "/tags.txt");
            $tags = explode(',', $tags_str);
            if(! in_array($org_name_en, $tags) && ! in_array(strtolower($org_name_en), $tags)) {
                $tags[] = $org_name_en;
            }
            if(! in_array( $org_name, $tags ) ) {
                $tags[] = $org_name;
            }
            if(! in_array( $origin['model'], $tags ) ) {
                $tags[] = $origin['model'];
            }
            $new_tags_str = implode(',', $tags);
            $new_tags_str = str_replace(strtolower($org_name_en), $org_name_en, $new_tags_str);
            echo "---- New tags: $new_tags_str \n";
            // create tags.txt
            echo "file_put_contents($the_full_path/tags.txt, $new_tags_str) \n";
            if(!$dryrun) file_put_contents($the_full_path.'/tags.txt', $new_tags_str);

            // create a new empty dl.txt in current folder
            echo "file_put_contents($the_full_path/dl.txt, '') \n";
            if(!$dryrun) file_put_contents($the_full_path.'/dl.txt', '');

            // If no thumbnail.jpg, rename last image to thumbnail.jpg
            $scan2 = scandir($the_full_path);
            $images = [];
            $already_has_thumbnail = false;
            foreach($scan2 as $file) {
                $origin_file_full = $the_full_path . '/' . $file;
                if($file == 'thumbnail.jpg') $already_has_thumbnail = true;
                if ( is_file($origin_file_full) && @is_array(getimagesize($origin_file_full)) ) {
                    $images[] = $file;
                }
            }
            // if((int)$vol < 37) {
            //     $thumb = $images[0];
            // }
            // else {
                $thumb = $images[count($images) - 1];
            // }
            if($already_has_thumbnail) {
                echo "---- Already has a thumbnail.jpg \n\n";
            }
            else {
                echo 'rename('. $the_full_path . '/' . $thumb . ', ' . $the_full_path . '/thumbnail.jpg' .  "\n\n";
                if(!$dryrun) rename($the_full_path . '/' . $thumb , $the_full_path . '/thumbnail.jpg');    
            }

            // // rename current folder to the origin folder name
            // $vol = str_replace('熊川纪信-no.', '熊川纪信-', $vol);
            // $origin['main'] = str_replace('-熊川纪信', '',$origin['main']);
            // echo "rename $the_full_path to $folder_full_path/".$org_name_en.$org_name."-". $vol. '-'. $origin['main'] . "\n\n";
            // if(!$dryrun) rename($the_full_path, $folder_full_path . '/'.$org_name_en.$org_name.'-' . $vol. '-'. $origin['main']);
        }
   }
}



function getOriginFolderByVol($vol_num) {
    global $org_name;
    
    // echo "vol_num = $vol_num \n";
    
    $origin_folders = '/mnt/nas/jw-photos/tujigu/' . $org_name;
    // $scan = scandir($origin_folders);
    global $dirs;
    $scan = explode("\r\n", $dirs);

    $folder_info = [];
    
    foreach($scan as $folder_name) {      
        // echo "folder: $folder_name \n";  
        if (is_dir("$origin_folders/$folder_name") && $folder_name!='.' && $folder_name!='..') {

            $l_folder_name = strtolower($folder_name);
            $l_folder_name = str_replace('vol.', 'no.', $l_folder_name);
            // echo "l_folder: $l_folder_name \n";
            
            if(strpos($l_folder_name, $vol_num) !== false) {
                $folder_info['full_path'] = $origin_folders  . '/' . $folder_name;

                $l_folder_name = str_replace('《','-',$l_folder_name);
                $l_folder_name = str_replace('》','-',$l_folder_name);
                $l_folder_name = str_replace('(','-',$l_folder_name);
                $l_folder_name = str_replace(')','-',$l_folder_name);
                $l_folder_name = str_replace('，','-',$l_folder_name);
                $l_folder_name = str_replace('、','-',$l_folder_name);
                $l_folder_name = str_replace('_-','_',$l_folder_name);
                $l_folder_name = str_replace('---','-',$l_folder_name);
                $l_folder_name = str_replace('--','-',$l_folder_name);
                $folder_info['name'] = $l_folder_name;

                $tt = find_between($l_folder_name, $org_name.'_', '-');
                if(str_starts_with($tt[0], 'no.')) {
                    $ss = explode('-', $l_folder_name);
                    $folder_info['model'] = $ss[1];
                    $yy = find_between($l_folder_name, '-', 'p-');
                    $main_arr = explode('-', $yy[0]);
                    array_pop($main_arr);
                    $main = implode('-', $main_arr);
                    $folder_info['main'] = $main;
                }
                else {
                    $folder_info['model'] = $tt[0];
                    $yy = find_between($l_folder_name, $org_name.'_', '-no');
                    $main = trim($yy[0], '-');
                    $folder_info['main'] = $main;
                }
            }
        }
    }

    return $folder_info;
}