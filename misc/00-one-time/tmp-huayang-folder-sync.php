<?php

$dirs = <<<EOF
网红馆_Cris_卓娅祺《华丽不失性感》-Vol.072-写真集-41P-
网红馆_Cris_卓娅祺《朦胧半透吊带》-Vol.074-写真集-45P-
网红馆_Cris_卓娅祺《浴室诱人的内衣私房魅惑》-Vol.076-写真集-44P-
网红馆_Cris_卓娅祺《私房魅惑》-Vol.058-写真集-41P-
网红馆_FoxYini孟狐狸《冬日里绽放的桃花》-Vol.006-写真集-53P-
网红馆_FoxYini孟狐狸《冬日里绽放的桃花》-VOL.048-写真集-41P-
网红馆_Mieko林美惠子《2018世界杯足球宝贝》-Vol.060-写真集-32P-
网红馆_Mieko林美惠子《性感肚兜-透视学生装》-VOL.057-写真集-41P-
网红馆_Sukki可儿《新春贺岁主题》-VOL.009-写真集-44P-
网红馆_Sukki《美厨娘-浴室美臀》-Vol.036-写真集-35P-
网红馆_Sukki《野性豹纹情趣SM装-性感浴袍》-VOL.014-写真集-44P-
网红馆_Sukki《黄金比基尼-透视内衣浴室湿身诱惑》-VOL.012-写真集-44P-
网红馆_-Vol.077-筱慧-《魅惑内衣与高跟鞋》-写真集-45P-
网红馆_-Vol.078-Cris_卓娅祺-《凹凸别致的惹火娇躯》-写真集-59P-
网红馆_-Vol.079-Cris_卓娅祺-《居家女友主题系列》-写真集-42P-
网红馆_-Vol.080-筱慧-《魅惑内衣与高跟鞋》-写真集-41P-
网红馆_-Vol.081-筱慧-《浴室私房》-写真集-38P-
网红馆_-Vol.082-孙梦瑶V---经典OL短裙网袜职业装-63P-
网红馆_中乌混血女神-伊莉娜-VOL.026-写真集-53P-
网红馆_中日混血模特-林美惠子Mieko《清远温泉外拍》-VOL.021-写真集-60P-
网红馆_伊莉娜-amp-amp-amp-芊惠《双人台球桌上面的碰撞》-Vol.068-写真集-34P-
网红馆_伊莉娜《丝袜主题》-Vol.038-写真集-37P-
网红馆_伊莉娜《唯美套裙-沙滩比基尼》-VOL.041-写真集-43P-
网红馆_伊莉娜《学生装-性感背心》-Vol.020-写真集-57P-
网红馆_伊莉娜《巴厘岛旅拍第四套》-VOL.043-写真集-46P-
网红馆_伊莉娜《海边沙滩女神系列》-VOL.024-写真集-61P-
网红馆_伊莉娜《牛仔热裤-泳池比基尼》-Vol.030-写真集-52P-
网红馆_俞公主《性感女秘书OL》-Vol.067-写真集-45P-
网红馆_夏小秋秋秋《2套内衣私房》-VOL.015-写真集-51P-
网红馆_夏小秋秋秋《奶油涂抹-性感背心》-VOL.017-写真集-42P-
网红馆_夏小秋秋秋《诱人美胸之第3套私房》-Vol.019-写真集-41P-
网红馆_孙梦瑶V《性感内衣》-Vol.071-写真集-44P-
网红馆_孙梦瑶V《撩人姿势惹火至极》-VOL.054-写真集-41P-
网红馆_小狐狸Kathryn《丝袜美腿》-Vol.062-写真集-46P-
网红馆_小狐狸Kathryn《黑色魅惑》-Vol.065-写真集-46P-
网红馆_小狐狸Sica《柔情万种的小狐狸》-VOL.045-写真集-63P-
网红馆_小狐狸Sica《黑丝诱惑》-Vol.052-写真集-46P-
网红馆_战姝羽Zina《滴水樱桃般的朱唇，无可比拟的性感美臀》-VOL.003-写真集-66P-
网红馆_战姝羽Zina《诱惑十足的比基尼-美臀》-Vol.034-写真集-41P-
网红馆_李宓儿《性感内衣-诱惑蕾丝网袜》-VOL.022-写真集-58P-
网红馆_李宓儿《比基尼湿身-性感内衣》-Vol.037-写真集-41P-
网红馆_李宓儿-陈美琳-小紫藤-卓芷伊《冬至主题写真》-VOL.005-写真集-38P-
网红馆_杨晨晨sugar《新春特辑》-Vol.053-写真集-49P-
网红馆_杨晨晨sugar《蕾丝内衣-可人女仆》-Vol.059-写真集-41P-
网红馆_林美惠子Mieko《一字马-兔女郎-丝袜美腿》-VOL.018-写真集-45P-
网红馆_林美惠子Mieko《两套海边比基尼系列》-VOL.042-写真集-40P-
网红馆_林美惠子Mieko《二次元少女-性感护士》-VOL.016-写真集-55P-
网红馆_林美惠子Mieko《外景海边-车内拍摄》-VOL.013-写真集-56P-
网红馆_林美惠子Mieko《大好的湿身诱惑》-Vol.050-写真集-21P-
网红馆_林美惠子Mieko《少女迷人的曲线美》-VOL.046-写真集-50P-
网红馆_林美惠子Mieko《护士装-死库水》-VOL.023-写真集-52P-
网红馆_林美惠子Mieko《校服主题》-VOL.027-写真集-39P-
网红馆_林美惠子Mieko《泳池湿身玩水》-Vol.028-写真集-39P-
网红馆_林美惠子Mieko《火辣比基尼》-VOL.025-写真集-60P-
网红馆_林美惠子Mieko《童颜巨乳的性感诱惑》-Vol.031-写真集-45P-
网红馆_林美惠子Mieko《肉袜与吉祥挂饰》-Vol.051-写真集-23P-
网红馆_林美惠子Mieko《蕾丝-长裙女神》-Vol.040-写真集-42P-
网红馆_林美惠子Mieko《黑丝与浴室私房》-Vol.035-写真集-37P-
网红馆_果儿Victoria《吃鸡游戏主题》-Vol.061-写真集-38P-
网红馆_果儿Victoria《性感美胸美腿私房》-Vol.064-写真集-40P-
网红馆_模特战姝羽Zina《4套服饰合集》-VOL.007-写真集-51P-
网红馆_王婉悠Queen《出浴美人-蕾丝黑丝诱惑》-Vol.069-写真集-39P-
网红馆_王诗琪《凹凸别致的邻家少女》-Vol.033-写真集-45P-
网红馆_琳琳ailin《清水出芙蓉，天然去雕饰的女神》-VOL.001-写真集-56P-
网红馆_筱慧《清纯学生制服与丁字裤》-Vol.073-写真集-46P-
网红馆_筱慧《魅惑内衣与高跟鞋之下美臀》-Vol.075-写真集-43P-
网红馆_米璐《邻家妹子的娇羞》-Vol.039-写真集-38P-
网红馆_美女主播-琳琳ailin《泳池系列》-VOL.008-写真集-65P-
网红馆_芊慧baby《丝袜美腿内衣系列》-Vol.029-写真集-42P-
网红馆_芊慧baby《比基尼主题》-Vol.032-写真集-42P-
网红馆_萌汉药baby很酷《春节喜庆不失性感内衣》-Vol.070-写真集-42P-
网红馆_萌琪琪Irene《不同风格服饰下的纤巧的曲线》-VOL.056-写真集-42P-
网红馆_萌琪琪Irene《沙发-睡衣系列》-Vol.049-写真集-51P-
网红馆_萌琪琪Irene《贵妃出浴影》-VOL.055-写真集-54P-
网红馆_萌琪琪Irene《运动装-白色比基尼》-VOL.044-写真集-56P-
网红馆_萌琪琪-王子妃-无名《圣诞礼物》-VOL.047-写真集-38P-
网红馆_谢芷馨Sindy《美少女系列》-VOL.002-写真集-56P-
网红馆_谢芷馨Sindy《透视睡衣、女仆装等4套服饰》-VOL.010-写真集-57P-
网红馆_酸酱兔《极致魅惑的淋漓诱惑》-Vol.066-写真集-43P-
网红馆_风格不同的媚态模特合集-VOL.011-写真集-31P-
EOF;

// 重命名文件夹用tujigu的名字，copy desc 和 tags，重命名thumbnail
if (!function_exists('str_starts_with')) {
    function str_starts_with($haystack, $needle) {
        return (string)$needle !== '' && strncmp($haystack, $needle, strlen($needle)) === 0;
    }
}

function find_between($str, $startDelimiter, $endDelimiter) {
    $contents = array();
    $startDelimiterLength = strlen($startDelimiter);
    $endDelimiterLength = strlen($endDelimiter);
    $startFrom = $contentStart = $contentEnd = 0;
    while (false !== ($contentStart = strpos($str, $startDelimiter, $startFrom))) {
      $contentStart += $startDelimiterLength;
      $contentEnd = strpos($str, $endDelimiter, $contentStart);
      if (false === $contentEnd) {
        break;
      }
      $contents[] = substr($str, $contentStart, $contentEnd - $contentStart);
      $startFrom = $contentEnd + $endDelimiterLength;
    }
  
    return $contents;
}

$folder_full_path = isset($argv[1]) ? $argv[1] : null;

if(empty($folder_full_path)) {
    echo "---- Must have a full folder path as the param! \n";
    exit;
}

$dryrun = 0;
$org_name = '糖果画报';
$org_name_en = 'Candy';

$scan = scandir($folder_full_path);
foreach($scan as $folder_name) {
   if (is_dir("$folder_full_path/$folder_name") && $folder_name!='.' && $folder_name!='..') {
        $the_full_path = "$folder_full_path/$folder_name";
        echo "------------------------- \n";
        echo "-- Current folder: $folder_name \n";
        // Get cuurent folder vol number
        $l_folder_name = strtolower($folder_name);
        $l_folder_name = str_replace('vol.', 'no.', $l_folder_name);
        // $v_arr = explode(' ',$l_folder_name);
        $v_arr = find_between($l_folder_name, 'no.', ' ');
        $vol = $v_arr[0];

        $vol = str_replace('no.', '', $vol);
        // Go to origin path to get folder name with the same vol num
        $origin = getOriginFolderByVol($vol);
        echo print_r($origin,1) . "\n"; 
        
        if(!empty($origin)) {
            // copy desc.txt and tags.txt from origin folder
            $desc_str = file_get_contents($origin['full_path'] . "/desc.txt");
            $desc_str = str_replace(' 生日','生日', $desc_str);
            $pos = strpos($desc_str, '生日');
            if($pos !== false) {
                $c = $desc_str[$pos-1];
                if ($c != "\n" && $c != "\rn" && $c != "\r") {
                    $desc_str = str_replace('生日',"\n生日", $desc_str);
                }
            }
            $desc_str = str_replace(' 罩杯','罩杯', $desc_str);
            $pos = strpos($desc_str, '罩杯');
            if($pos !== false) {
                $c = $desc_str[$pos-1];
                if ($c != "\n" && $c != "\rn" && $c != "\r") {
                    $desc_str = str_replace('罩杯',"\n罩杯", $desc_str);
                }
            }
            echo "Processing " . $the_full_path . "/desc.txt \n";
            if(!$dryrun) file_put_contents($the_full_path.'/desc.txt', $desc_str);
            
            // copy($origin['full_path'] . "/tags.txt", $the_full_path . "/tags.txt");

            // Gen new tags
            $tags_str = file_get_contents($origin['full_path'] . "/tags.txt");
            $tags = explode(',', $tags_str);
            if(! in_array($org_name_en, $tags) && ! in_array(strtolower($org_name_en), $tags)) {
                $tags[] = $org_name_en;
            }
            if(! in_array( $org_name, $tags ) ) {
                $tags[] = $org_name;
            }
            if(! in_array( '网红馆', $tags ) ) {
                $tags[] = '网红馆';
            }
            if(! in_array( $origin['model'], $tags ) ) {
                $tags[] = $origin['model'];
            }
            $new_tags_str = implode(',', $tags);
            $new_tags_str = str_replace(strtolower($org_name_en), $org_name_en, $new_tags_str);
            echo "---- New tags: $new_tags_str \n";
            // create tags.txt
            echo "file_put_contents($the_full_path/tags.txt, $new_tags_str) \n";
            if(!$dryrun) file_put_contents($the_full_path.'/tags.txt', $new_tags_str);

            // create a new empty dl.txt in current folder
            echo "file_put_contents($the_full_path/dl.txt, '') \n";
            if(!$dryrun) file_put_contents($the_full_path.'/dl.txt', '');

            // If no thumbnail.jpg, rename last image to thumbnail.jpg
            $scan2 = scandir($the_full_path);
            $images = [];
            $already_has_thumbnail = false;
            foreach($scan2 as $file) {
                $origin_file_full = $the_full_path . '/' . $file;
                if($file == 'thumbnail.jpg') $already_has_thumbnail = true;
                if ( is_file($origin_file_full) && @is_array(getimagesize($origin_file_full)) ) {
                    $images[] = $file;
                }
            }
            // if((int)$vol < 37) {
            //     $thumb = $images[0];
            // }
            // else {
                $thumb = $images[count($images) - 1];
            // }
            if($already_has_thumbnail) {
                echo "---- Already has a thumbnail.jpg \n\n";
            }
            else {
                echo 'rename('. $the_full_path . '/' . $thumb . ', ' . $the_full_path . '/thumbnail.jpg' .  "\n\n";
                if(!$dryrun) rename($the_full_path . '/' . $thumb , $the_full_path . '/thumbnail.jpg');    
            }

            // rename current folder to the origin folder name
            if(!empty($origin['main'] )) {
                $t_folder_name = str_replace('[CANDY糖果画报]', 'Candy糖果画报-', $folder_name);
                $t_folder_name = str_replace('[Candy网红馆] ', 'Candy网红馆-', $t_folder_name);
                $x = find_between($t_folder_name, '-', ' VOL');
                $last = $x[0];
                
                $folder_name_p1 = strpos($folder_name, '糖果画报') !== false ? 'Candy糖果画报-' : 'Candy网红馆-';
                $new_folder_name = $folder_name_p1 . $vol . '-'.$origin['model'] . '-' . $origin['main'] . '-'.$last;
                echo "rename $the_full_path to $folder_full_path/$new_folder_name\n\n";
                if(!$dryrun) rename($the_full_path, $folder_full_path . '/'.$new_folder_name);
            }
            
        }
        else {
            echo "-- Cannot find mapped folder ...\n";
        }
   }
}



function getOriginFolderByVol($vol_num) {
    global $dirs;
    
    //global $org_name;
    $org_name = '网红馆';
    // echo "vol_num = $vol_num \n"; exit;
    
    $origin_folders = '/mnt/nas/jw-photos/tujigu/' . $org_name;
    // $scan = scandir($origin_folders);
    $scan = explode("\r\n", $dirs);

    $folder_info = [];
    
    foreach($scan as $folder_name) {      
        // echo "folder: $folder_name \n";  
        if (is_dir("$origin_folders/$folder_name") && $folder_name!='.' && $folder_name!='..') {

            $l_folder_name = strtolower($folder_name);
            $l_folder_name = str_replace('vol.', 'no.', $l_folder_name);
            // echo "l_folder: $l_folder_name \n";
            
            if(strpos($l_folder_name, $vol_num) !== false) {
                $folder_info['full_path'] = $origin_folders  . '/' . $folder_name;

                $l_folder_name = sanatizeCN($l_folder_name);
                $l_folder_name = str_replace('_-','_',$l_folder_name);
                $l_folder_name = str_replace('---','-',$l_folder_name);
                $l_folder_name = str_replace('--','-',$l_folder_name);
                $folder_info['name'] = $l_folder_name;

                $tt = find_between($l_folder_name, $org_name.'_', '-');
                if(str_starts_with($tt[0], 'no.')) {
                    $ss = find_between($l_folder_name, '-', '-');
                    $folder_info['model'] = my_mb_ucfirst(sanatizeCN($ss[0]));
                    // Get "main"
                    // $yy = find_between($l_folder_name, '-', 'p-');
                    // $main_arr = explode('-', $yy[0]);
                    // array_pop($main_arr);
                    // $main = implode('-', $main_arr);
                    // $folder_info['main'] = $main;
                    // $folder_info['main'] = '';
                }
                else {
                    $xx = find_between($l_folder_name, $org_name.'_', '-');
                    $folder_info['model'] = my_mb_ucfirst(sanatizeCN($xx[0]));
                    //$yy = find_between($l_folder_name, $org_name.'_', '-no');
                    
                }
                $yy = find_between($folder_name, '《', '》');
                $main = empty($yy[0]) ? '' : trim($yy[0], '-');
                $main = empty($main) ? '' : '《' .my_mb_ucfirst(sanatizeCN($main))  . '》';
                $folder_info['main'] = $main;
                continue;
            }
        }
    }

    return $folder_info;
}

function sanatizeCN($string) {
    $string = str_replace('《','-',$string);
    $string = str_replace('》','-',$string);
    $string = str_replace('(','-',$string);
    $string = str_replace(')','-',$string);
    $string = str_replace('，','-',$string);
    $string = str_replace('、','-',$string);
    $string = str_replace('&','-',$string);

    return $string;
}
function my_mb_ucfirst($str) {
    $new_str = '';
    $do_it = true;
    for ($i = 0; $i < strlen($str); $i++) {
        if(ord($str[$i]) >=97 && ord($str[$i]) <=122) {
            if($do_it) {
                $new_str[$i] = strtoupper($str[$i]);
                $do_it = false;
            }
            else {
                $new_str[$i] = $str[$i];
            }
        }
        else {
            $new_str[$i] = $str[$i];
        }

    }
    return $new_str;
}