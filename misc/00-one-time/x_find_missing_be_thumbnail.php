<?php
require_once '../../bootstrap.inc';

set_time_limit(0);
ini_set('memory_limit','2048M');
ini_set('display_errors', 1);
error_reporting(E_ALL & ~E_NOTICE & ~E_WARNING);

$pre = Config::get('db_table_prefix');

$file_id = isset($argv[1]) ? (int)$argv[1] : 0;


echo "#####################################\n";
echo date('Y-m-d H:i:s') . ' - ' . "Start re-handling tags for tujigu photos .... \n";
echo date('Y-m-d H:i:s') . ' - ' . "-- on " . Config::get('theme') . " \n";
echo "#####################################\n";

$num = 0;

// Get all rows which source is tujigu
$query = 'SELECT * FROM '. $pre . 'files where id in (950,1768,2119,2231,2261,2269,2485,2602,2794,2891,2924,2951,3141,3451,3452,3558,3628,3651,3811,4219,4367,4428,4606,4744,5151,5204,5212,5314,5326,5367,5415,5477,5559,5563,5568,5592,5674,5693,5751,5755,5834,5883,6091,6114,6190,6236,6237,6307,6418,6477,6622,6628,6691,6832,6865,6897,6982,7046,7131,7328,7371,7378,7415,7416,7428,7437,7576,7578,7625,7633,7746,7756,7800,7833,7951,7955,8023,8026,8036,8117,8158,8552,8590,8680,8700,8716,8740,8750,8980,8987,9005,9150,9162,9339,9419,9434,9481,9651,9652,9698,9736,9752,9794,9808,9870,9901,10052,10161,10165,10260,10314,10367,10369,10395,10413,10419,10432,10434,10473,10493,10514,10564,10619,10723,10748,10773,10801,10817,10867,10872,10878,10901,11033,11065,11154,11653,11663,11718,11736,11824,11826,11964,11981,12054,12090,12188,12192,12240,12294,12319,12326,12535,12630,12663,12704,12843,12871,12897,12914,12996,13026,13058,13158,13163,13172,13189,13260,13286,13312,13477,13522,13630,13667,13688,13713,13860,13956,13990,14026,14027,14044,14067,14230,14332,14334,14343,14425,14433,14484,14488,14490,14531,14563,14566,14593,14632,14750,14751,14825,14834,14849,14857,14950,14960,15068,15099,15113,15124,15204,15376,15418,15428,15511,15523,15576,15580,15688,15694,15698,15754,15756,15757,15772,15860,15952,16005,16080,16108,16170,16230,16330,16364,16368,16433,16461,16463,16521,16529,16533,16574,16581,16613,16669,16691,16789,16850,16961,17031,17079,17139,17205,17225,17227,17291,17496,17510,17516,17576,17639,17726,17739,17745,17751,17759,17812,17817,17858,17879,17968,18133,18154,18245,18349,18359,18373,18441,18449,18548,18627,18686,18777,18790,18798,18834,18902,19193,19220,19221,19222,19382,19410,19701,19735,19765,19771,19957,19972,19999,20015,20159,20252,20272,20290,20420,20563,20657,20732,20751,20849,20920,20922,20944,20976,21007,21021,21130,21138,21312,21323,21543,21581,21584,21592,21892,21895,21905,21923,22185,22281,22282,22302,22500,22586,22614,22654,22710,22761,22794,22880,22888,22900,22903,23050,23070,23122,23239,23265,23275,23289,23307,23502,23513,23520,23538,23556,23617,23650,23689,23850,23872,23966,23986,24008,24041,24085,24237,24303,24408,24455,24527,24537,24550,24574,24579,24679,24684,24692,24767,24784,24880,25017,25034,25071,25093,25148,25177,25207,25356,25389,25472,25809,25866,25989,26008,26116,26164,26236,26264,26345,26452,26542,26549,26566,26593,26609,26612,26621,26622,26626,26628,26630,26631,26635,26636,26641,26642,26646,26654,26655,26660,26661,26665,26667,26668,26679,26686,26687,26690,26691,26695,26696,26703,26707,26711,26712,26713,26714,26715,26716,26724,26725,26728,26729,26733,26735,26736,26737,26740,26744,26753,26754,26760,26762,26765,26768,26774,26775,26777,26779,26781,26787,26792,26793,26796,26797,26798,26799,26800,26801,26803,26804,26806,26808,26809,26810,26811,26812,26813,26814,26815,26817,26818,26819,26823,26824,26826,26829,26834,26835,26839,26842,26846,26850,26853,26856,26861,26862,26865,26870,26872,26873,26874,26875,26879,26880,26882,26883,26884,26885,26887,26890,26891,26892,26894,26899,26901,26903,26904,26906,26907,26914,26915,26916,26921,26922,26924,26925,26930,26931,26934,26938,26943,26944,26945,26948,26955,26956,26959,26963,26966,26967,26969,26970,26971,26973,26978,26982,26983,26984,26986,26989,26991,26992,26994,26995,26997,26998,27013,27014,27015,27016,27017,27018,27021,27024,27025,27034,27037,27039,27041,27043,27044,27046,27048,27049,27054,27055,27056,27061,27062,27063,27064,27066,27069,27070,27073,27076,27077,27079,27082,27083,27085,27087,27088,27089,27093,27095,27096,27098,27099,27100,27101,27103,27105,27108,27109,27110,27114,27116,27117,27118,27119,27120,27122,27125,27130,27131,27133,27136,27137,27143,27145,27147,27148,27149,27150,27153,27154,27157,27158,27159,27160,27164,27166,27174,27175,27176,27185,27186,27187,27188,27193,27195,27197,27203,27207,27210,27211,27212,27214,27220,27221,27228,27229,27230,27231,27233,27236,27237,27238,27240,27241,27243,27244,27246,27247,27248,27259,27260,27262,27263,27269,27270,27275,27280,27281,27282,27287,27289,27293,27295,27299,27302,27305,27310,27311,27312,27315,27450,27463,27662,27802,27834,27938,27982,28036,28119,28146,28149,28157,28210,28219,28279,28363,28439,28444,28471,28535,28633,28791,28847,28954,29092,29098,29121,29177,29230,29232,29331,29332,29338,29342,29368,29384,29410,29413,29418,29439,29440,29449,29495,29533,29542,29555,29563,29578,29659,29679,29703,29887,29923,29936,29943,29949,29972,30024,30040,30066,30073,30095,30122,30130,30133,30183,30226,30249,30272,30278,30313,30396,30401,30402,30450,30498,30504,30510,30544,30574,30604,30684,30697,30730,30735,30738,30774,30968,30977,31115,31213,31231,31310,31402,3145,31560,31589,31591,31601,31605,31615,31625,31629,31633,31639,31646,31656,31657,31660,31662,31663,31668,31671,31673,31675)';

$res = DB::$dbInstance->getRows($query);
if(count($res) >0) {
    foreach ($res as $row) {
        echo date('Y-m-d H:i:s') . ' - ' . ($num+1) . " - processing: id=" . $row['id'] .', '. $row['title'] . " \n";
        
        // Get B2 header of the thumbnail
        $physical_path = buildPhysicalPath($row);
        $base_b2_url = 'https://img.tuzac.com/file/jw-photos-2021/';
        $file_root = Config::get('file_root');
        $relative_path = str_replace($file_root, '', $physical_path);
        $key = $relative_path . '/thumbnail.jpg';
        $img_src = $base_b2_url . str_replace('%2F','/', urlencode($key));
        $file_headers = @get_headers($img_src);
        if(!empty($file_headers) && strpos($file_headers[0], '200') !== false) 
        {
            echo date('Y-m-d H:i:s') . " ------- ok \n";
        }
        else {
            echo date('Y-m-d H:i:s') . " ------- \033[31m Not found! \033[39m ID=".$row['id'].": ".$row['title']." \n";
            echo date('Y-m-d H:i:s') . " ------- uploading... \n";
            $full_path = $physical_path . '/thumbnail.jpg';
            $res = $b2->upload_photo($key, $full_path);
        }
        $num++;
    }
}