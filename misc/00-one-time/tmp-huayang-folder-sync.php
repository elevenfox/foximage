<?php

$dirs = <<<EOF
瑞丝馆_Breeze奕《性感黑丝内衣下曼妙多姿的娇躯》-Vol.059-写真集-41P-
瑞丝馆_Buylu《身娇体柔的软妹子》-Vol.089-写真集-48P-
瑞丝馆_Daisy琳琳《清新甜美的妹子》-Vol.062-写真集-42P-
瑞丝馆_Daisy琳琳《清新甜美的妹子》-Vol.082-写真集-48P-
瑞丝馆_Egg_尤妮丝《大胆私房诱惑》-Vol.053-写真集-35P-
瑞丝馆_Eileen爱琳《身姿娇小但玲珑有致的软妹子》-Vol.072-写真集-40P-
瑞丝馆_Eileen爱琳《身姿娇小但玲珑有致的软妹子》-Vol.075-写真集-44P-
瑞丝馆_K8傲娇萌萌Vivian《不同颜色的丝袜妩媚诱惑》-VOL.011-写真集-52P-
瑞丝馆_K8傲娇萌萌Vivian《丝袜主题写真》-VOL.017-写真集-63P-
瑞丝馆_M梦baby《泡泡浴》-Vol.052-写真集-38P-
瑞丝馆_M梦baby《魅惑白衬衫》-Vol.051-写真集-39P-
瑞丝馆_M梦baby《魅惑私房》-Vol.048-写真集-40P-
瑞丝馆_Tobey轩轩酱《娇小可人的软妹子》-Vol.078-写真集-40P-
瑞丝馆_人间不值得lily《身娇体柔的娇滴滴妹子》-Vol.087-写真集-42P-
瑞丝馆_凯竹BuiBui《长裙街拍-蕾丝内衣》-Vol.013-写真集-47P-
瑞丝馆_叶佳颐《美腿-浴室系列》-Vol.030-写真集-44P-
瑞丝馆_周于希dummy《黑丝美腿丁字裤-浴室诱惑》-Vol.031-写真集-37P-
瑞丝馆_周于希和闺蜜《私房缠绵美臀诱惑》--VOL.014-写真集-30P-
瑞丝馆_圆圆Daphne《娇柔清纯可人的软妹子》-Vol.067-写真集-42P-
瑞丝馆_圆圆Daphne《娇柔清纯可人的软妹子》-Vol.069-写真集-50P-
瑞丝馆_土肥圆矮挫穷《5套情趣服饰主题》-Vol.042-写真集-45P-
瑞丝馆_土肥圆矮挫穷《5套服装主题》-Vol.046-写真集-44P-
瑞丝馆_土肥圆矮挫穷《制服主题写真》-Vol.039-写真集-45P-
瑞丝馆_土肥圆矮挫穷-周妍希《花样万种风情诱惑》-Vol.040-写真集-45P-
瑞丝馆_土肥圆矮挫穷《女仆主题》-Vol.028-写真集-45P-
瑞丝馆_土肥圆矮挫穷《女仆-开叉礼服-室外内衣》-Vol.029-写真集-45P-
瑞丝馆_土肥圆矮挫穷《暖光下拍摄的女神》-VOL.026-写真集-45P-
瑞丝馆_土肥圆矮挫穷《服装秀系列！》-Vol.038-写真集-45P-
瑞丝馆_土肥圆矮挫穷《浴巾裹胸系列》-Vol.015-写真集-20P-
瑞丝馆_土肥圆矮挫穷《百变情趣内衣》-VOL.034-写真集-45P-
瑞丝馆_土肥圆矮挫穷《真空毛衣内衣》-Vol.032-写真集-45P-
瑞丝馆_土肥圆矮挫穷《美腿与丝袜的致命诱惑》-VOL.008-写真集-43P-
瑞丝馆_土肥圆矮挫穷《诱人黑丝与妩媚小吊带系列》-VOL.033-写真集-45P-
瑞丝馆_土肥圆矮挫穷《魅惑丝袜》-VOL.036-写真集-45P-
瑞丝馆_土肥圆矮挫穷《黑丝内衣诱惑》-VOL.035-写真集-45P-
瑞丝馆_夏笑笑Summer《少女动心诱惑》-Vol.043-写真集-41P-
瑞丝馆_夏笑笑Summer《柔美如玉的少女动心诱惑》-VOL.027-写真集-47P-
瑞丝馆_女神-周妍希《服装主题写真》-Vol.041-写真集-45P-
瑞丝馆_奶瓶土肥圆《丝袜美腿控的福利》-Vol.054-写真集-45P-
瑞丝馆_奶瓶土肥圆矮挫丑黑穷《美妙妖娆的曲线》-Vol.055-写真集-51P-
瑞丝馆_小葡萄miki《唯美不失性感》-Vol.085-写真集-43P-
瑞丝馆_小葡萄miki《梦幻光线与诱人蕾丝的巧妙结合》-Vol.079-写真集-42P-
瑞丝馆_巨乳女神王婉悠Queen-VOL.012-写真集-47P-
瑞丝馆_性感女神-Egg-尤妮丝《诱人的邀请》-Vol.047-写真集-23P-
瑞丝馆_性感女神-萌琪琪Irene-VOL.016-写真集-50P-
瑞丝馆_慕西Mona《富含御姐气息的美女》-Vol.065-写真集-43P-
瑞丝馆_慕西Mona《真空薄纱系列》-Vol.071-写真集-44P-
瑞丝馆_新人模特画画sugar-VOL.004-写真集-50P-
瑞丝馆_木木夕Mmx《各式性感女仆厨娘制服系列》-Vol.064-写真集-42P
瑞丝馆_木木夕Mmx《唯美性感内衣系列》-Vol.081-写真集-46P-
瑞丝馆_木木夕Mmx《娇柔可人温柔乖巧的清纯妹子》-Vol.063-写真集-40P-
瑞丝馆_木木夕Mmx《性感内衣系列》-Vol.070-写真集-46P-
瑞丝馆_木木夕Mmx《花样百变的主题服饰系列》-Vol.083-写真集-53P-
瑞丝馆_李可可《蕾丝镂空半透内衣》-Vol.056-写真集-48P-
瑞丝馆_李可可《蕾丝镂空半透内衣装扮》-Vol.058-写真集-50P-
瑞丝馆_楚楚baby《材高挑多姿颜值清秀精致的美女》-Vol.057-写真集-50P-
瑞丝馆_模特M梦baby《柔情私房》-Vol.045-写真集-40P-
瑞丝馆_模特M梦baby《黑丝吊袜》-Vol.050-写真集-40P-
瑞丝馆_浪漫果味《新人模特首套》-Vol.073-写真集-35P-
瑞丝馆_深紫Julie《私房内的清甜可人草帽女孩系列》-Vol.068-写真集-47P-
瑞丝馆_深紫Julie《首套写真》-Vol.066-写真集-39P-
瑞丝馆_清纯妹子-玟姊BABY首套私房-VOL.007-写真集-50P-
瑞丝馆_清纯甜美妹子-米粒sweet-Vol.037-写真集-40P-
瑞丝馆_潘琳琳ber《巨乳粉红女郎》-Vol.076-写真集-37P-
瑞丝馆_潘琳琳ber《巨乳肥臀尤物》-Vol.086-写真集-35P-
瑞丝馆_潘琳琳ber《巨乳肥臀熟女气息十足》-Vol.074-写真集-30P-
瑞丝馆_潘琳琳ber《巨乳肥臀熟女气息十足》-Vol.077-写真集-35P-
瑞丝馆_白沫《身材苗条美腿修长诱人》-Vol.060-写真集-37P-
瑞丝馆_筱慧-Vol.088-写真集-43P-
瑞丝馆_筱慧《白衬衫丝袜牛仔裤的精彩美臀诱惑》-Vol.084-写真集-46P-
瑞丝馆_美女主播-周于希dummy-VOL.003-写真集-45P-
瑞丝馆_美女主播-孙梦瑶V-VOL.018-写真集-45P-
瑞丝馆_萌琪琪Irene《丝袜诱惑系列》-VOL.005-写真集-47P-
瑞丝馆_萌琪琪Irene《兔女郎与性感猫耳》-VOL.009-写真集-50P-
瑞丝馆_萌琪琪Irene《皮鞭、黑丝、兔女郎、空姐等服饰》-VOL.001-写真集-50P-
瑞丝馆_萌琪琪Irene《花样性感情趣内衣》-VOL.021-写真集-50P-
瑞丝馆_萌琪琪Irene《透视性感内衣-情趣丝袜》-VOL.025-写真集-50P-
瑞丝馆_萌琪琪Irene《透视旗袍、黑丝美腿》-VOL.006-写真集-50P-
瑞丝馆_豆浆妹《颜值跟身材都很不错的妹子》-Vol.061-写真集-65P-
瑞丝馆_雪瑞Lisa《不同颜色的丝袜与眼镜OL》-VOL.024-写真集-46P-
瑞丝馆_雪瑞Lisa《丝袜主题写真》-VOL.020-写真集-51P-
瑞丝馆_雪瑞Lisa《低胸睡衣、女仆装、学生装、蕾丝袜》-VOL.022-写真集-54P-
瑞丝馆_雪瑞Lisa《肚兜-黑丝诱惑》-VOL.010-写真集-52P-
瑞丝馆_雪瑞Lisa《诱人身材与丝袜诱惑》-VOL.019-写真集-52P-
瑞丝馆_顾北北《少女的芳香》-VOL.023-写真集-40P-
瑞丝馆_风衣月Lucy《肌肤跟身材都不错的妹子》-Vol.080-写真集-46P-
瑞丝馆_麦提娜Mitina《呼之欲出的美胸》-VOL.002-写真集-50P-
EOF;

// 重命名文件夹用tujigu的名字，copy desc 和 tags，重命名thumbnail
if (!function_exists('str_starts_with')) {
    function str_starts_with($haystack, $needle) {
        return (string)$needle !== '' && strncmp($haystack, $needle, strlen($needle)) === 0;
    }
}

function find_between($str, $startDelimiter, $endDelimiter) {
    $contents = array();
    $startDelimiterLength = strlen($startDelimiter);
    $endDelimiterLength = strlen($endDelimiter);
    $startFrom = $contentStart = $contentEnd = 0;
    while (false !== ($contentStart = strpos($str, $startDelimiter, $startFrom))) {
      $contentStart += $startDelimiterLength;
      $contentEnd = strpos($str, $endDelimiter, $contentStart);
      if (false === $contentEnd) {
        break;
      }
      $contents[] = substr($str, $contentStart, $contentEnd - $contentStart);
      $startFrom = $contentEnd + $endDelimiterLength;
    }
  
    return $contents;
}

$folder_full_path = isset($argv[1]) ? $argv[1] : null;

if(empty($folder_full_path)) {
    echo "---- Must have a full folder path as the param! \n";
    exit;
}

$dryrun = 0;

$scan = scandir($folder_full_path);
foreach($scan as $folder_name) {
   if (is_dir("$folder_full_path/$folder_name") && $folder_name!='.' && $folder_name!='..') {
        $the_full_path = "$folder_full_path/$folder_name";
        echo "------------------------- \n";
        echo "-- Current folder: $folder_name \n";
        // Get cuurent folder vol number
        $l_folder_name = strtolower($folder_name);
        $v_arr = explode(' ',$l_folder_name);
        $vol = $v_arr[1];

        $vol = str_replace('vol.', '', $vol);
        // Go to origin path to get folder name with the same vol num
        $origin = getOriginFolderByVol($vol);
        echo print_r($origin,1) . "\n"; 
        
        if(!empty($origin)) {
            // copy desc.txt and tags.txt from origin folder
            echo "copy " . $origin['full_path'] . "/desc.txt " . $the_full_path . "/\n";
            if(!$dryrun) copy($origin['full_path'] . "/desc.txt", $the_full_path . "/desc.txt");
            
            // copy($origin['full_path'] . "/tags.txt", $the_full_path . "/tags.txt");

            // Gen new tags
            $tags_str = file_get_contents($origin['full_path'] . "/tags.txt");
            $tags = explode(',', $tags_str);
            if(! in_array('RuiSG', $tags) && ! in_array('ruisg', $tags)) {
                $tags[] = 'RuiSG';
            }
            if(! in_array( '瑞丝馆', $tags ) ) {
                $tags[] = '瑞丝馆';
            }
            if(! in_array('MiCat', $tags) && ! in_array('micat', $tags)) {
                $tags[] = 'MiCat';
            }
            if(! in_array( '猫萌榜', $tags ) ) {
                $tags[] = '猫萌榜';
            }
            if(! in_array( $origin['model'], $tags ) ) {
                $tags[] = $origin['model'];
            }
            $new_tags_str = implode(',', $tags);
            $new_tags_str = str_replace('ruisg', 'RuiSG', $new_tags_str);
            echo "---- New tags: $new_tags_str \n";
            // create tags.txt
            echo "file_put_contents($the_full_path/tags.txt, $new_tags_str) \n";
            if(!$dryrun) file_put_contents($the_full_path.'/tags.txt', $new_tags_str);

            // create a new empty dl.txt in current folder
            echo "file_put_contents($the_full_path/dl.txt, '') \n";
            if(!$dryrun) file_put_contents($the_full_path.'/dl.txt', '');

            // If no thumbnail.jpg, rename last image to thumbnail.jpg
            $scan2 = scandir($the_full_path);
            $images = [];
            foreach($scan2 as $file) {
                $origin_file_full = $the_full_path . '/' . $file;
                if ( is_file($origin_file_full) && @is_array(getimagesize($origin_file_full)) ) {
                    $images[] = $file;
                }
            }
            // if((int)$vol > 34 && (int)$vol < 282) {
                $thumb = $images[0];
            // }
            // else {
                // $thumb = $images[count($images) - 1];
            // }
            echo 'rename('. $the_full_path . '/' . $thumb . ', ' . $the_full_path . '/thumbnail.jpg' .  "\n\n";
            if(!$dryrun) rename($the_full_path . '/' . $thumb , $the_full_path . '/thumbnail.jpg');    

            // rename current folder to the origin folder name
            echo "rename $the_full_path to $folder_full_path/MiCat猫萌榜-". $vol. '-'. $origin['main'] . "\n\n";
            if(!$dryrun) rename($the_full_path, $folder_full_path . '/MiCat猫萌榜-' . $vol. '-'. $origin['main']);
        }
   }
}



function getOriginFolderByVol($vol_num) {
    // $vol_num = '第' . (int)$vol_num . '期';
    // echo "vol_num = $vol_num \n";
    
    $origin_folders = '/mnt/nas/jw-photos/tujigu/瑞丝馆';
    // $scan = scandir($origin_folders);
    global $dirs;
    $scan = explode("\r\n", $dirs);

    $folder_info = [];
    
    foreach($scan as $folder_name) {      
        // echo "folder: $folder_name \n";  
        if (is_dir("$origin_folders/$folder_name") && $folder_name!='.' && $folder_name!='..') {
            $l_folder_name = strtolower($folder_name);
            // echo "l_folder: $l_folder_name \n";
            
            if(strpos($l_folder_name, $vol_num) !== false) {
                $l_folder_name = str_replace('---','-',$l_folder_name);
                $l_folder_name = str_replace('--','-',$l_folder_name);
                $l_folder_name = str_replace('《','-',$l_folder_name);
                $l_folder_name = str_replace('》','-',$l_folder_name);
                $l_folder_name = str_replace('_-','_',$l_folder_name);
                $folder_info['name'] = $l_folder_name;
                $folder_info['full_path'] = $origin_folders  . '/' . $folder_name;

                $tt = find_between($l_folder_name, '瑞丝馆_', '-');
                if(str_starts_with($tt[0], 'vol.')) {
                    $ss = explode('-', $l_folder_name);
                    $folder_info['model'] = $ss[1];
                    $yy = find_between($l_folder_name, '-', 'p-');
                    $main_arr = explode('-', $yy[0]);
                    array_pop($main_arr);
                    $main = implode('-', $main_arr);
                    $folder_info['main'] = $main;
                }
                else {
                    $folder_info['model'] = $tt[0];
                    $yy = find_between($l_folder_name, '瑞丝馆_', '-vol');
                    $main = trim($yy[0], '-');
                    $folder_info['main'] = $main;
                }
            }
        }
    }

    return $folder_info;
}