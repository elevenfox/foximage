<?php
$sources = array(
	// Tujigu  China beauty 50 pages
    'tujigu.com' => array(
        'key_class_name' => 'hezi',
        'keywords_of_file_link' => '/a/',
        'tag_links' => array(
            //'https://www.tujigu.com/zhongguo/#page.html', // 中国美女
			
			'https://www.tujigu.com/x/108/', // 山茶摄影 167

			'https://www.tujigu.com/x/107/', // 奈丝 148
			//'https://www.tujigu.com/x/107/index_#page.html', // 奈丝

			'https://www.tujigu.com/x/106/', // 大生模拍 index  163
			//'https://www.tujigu.com/x/106/index_#page.html', //大生模拍 index
 
			'https://www.tujigu.com/x/105/', // 佳爷SJA   51
			//'https://www.tujigu.com/x/105/index_#page.html', // 佳爷SJA

			'https://www.tujigu.com/x/104/', // 袜涩   81
			'https://www.tujigu.com/x/103/', // 思话   210
			'https://www.tujigu.com/x/102/', // 丝慕   545

			'https://www.tujigu.com/x/101/', // ARTGRAVIA 29

			'https://www.tujigu.com/x/100/', //一千零一夜 181
			//'https://www.tujigu.com/x/100/index_#page.html', // 一千零一夜

			'https://www.tujigu.com/x/99/', //丽丝映像 83
			//'https://www.tujigu.com/x/99/index_#page.html', //丽丝映像

			'https://www.tujigu.com/x/98/', //斯文传媒  92
			//'https://www.tujigu.com/x/98/index_#page.html', //斯文传媒

			'https://www.tujigu.com/x/97/', // 轻兰映画  30

			'https://www.tujigu.com/x/96/', // NS纳丝摄影 84
			//'https://www.tujigu.com/x/96/index_#page.html', // NS纳丝摄影

			'https://www.tujigu.com/x/95/', //喵糖映画  447
			//'https://www.tujigu.com/x/95/index_#page.html', //喵糖映画

			'https://www.tujigu.com/x/94/', //Young Magazine杂志写真  279  日本
			//'https://www.tujigu.com/x/94/index_#page.html', //Young Magazine杂志写真

			'https://www.tujigu.com/x/93/', //Young Gangan杂志写真  132   日本
			//'https://www.tujigu.com/x/93/index_#page.html', //Young Gangan杂志写真
 
			'https://www.tujigu.com/x/92/', //Young Champion杂志写真  155  日本
			// 'https://www.tujigu.com/x/92/index_#page.html', //Young Champion杂志写真

			'https://www.tujigu.com/x/91/', //Weekly Big Comic Spirits杂志写真  280  日本
			//'https://www.tujigu.com/x/91/index_#page.html', //Weekly Big Comic Spirits杂志写真

			'https://www.tujigu.com/x/90/', //FRIDAY杂志  99  日本
			// 'https://www.tujigu.com/x/90/index_#page.html', //FRIDAY杂志

			'https://www.tujigu.com/x/89/', //FLASH写真杂志  152  日本
			// 'https://www.tujigu.com/x/89/index_#page.html', //FLASH写真杂志

			'https://www.tujigu.com/x/88/', //阳光宝贝 46
			// 'https://www.tujigu.com/x/88/index_#page.html', //阳光宝贝

			'https://www.tujigu.com/x/87/', //丝意SIEE 258
			// 'https://www.tujigu.com/x/87/index_#page.html', //丝意SIEE 
			
			'https://www.tujigu.com/x/86/', //风之领域  149
			// 'https://www.tujigu.com/x/86/index_#page.html', //风之领域 

			'https://www.tujigu.com/x/85/', //语画界  442
			// 'https://www.tujigu.com/x/85/index_#page.html', //语画界

			'https://www.tujigu.com/x/84/', //YouMei尤美  93
			// 'https://www.tujigu.com/x/84/index_#page.html', //YouMei尤美

			'https://www.tujigu.com/x/83/', //日本CosPlay  514  日本
			// 'https://www.tujigu.com/x/83/index_#page.html', //日本CosPlay
			
			'https://www.tujigu.com/x/82/', //森萝财团   203
			// 'https://www.tujigu.com/x/82/index_#page.html', //森萝财团

			'https://www.tujigu.com/x/81/', //蜜丝MISSLEG   58
			// 'https://www.tujigu.com/x/81/index_#page.html', //蜜丝MISSLEG

			'https://www.tujigu.com/x/80/', //Cosdoki    581  日本
			// 'https://www.tujigu.com/x/80/index_#page.html', //Cosdoki

			'https://www.tujigu.com/x/79/', //Girlz-High   712  日本
			// 'https://www.tujigu.com/x/79/index_#page.html', //Girlz-High
			
			'https://www.tujigu.com/x/78/', //台湾女神    689
			// 'https://www.tujigu.com/x/78/index_#page.html', //台湾女神

			'https://www.tujigu.com/x/77/', //猎女神    20

			'https://www.tujigu.com/x/76/', //欧美OnlyTease丝袜   721
			// 'https://www.tujigu.com/x/76/index_#page.html', //欧美OnlyTease丝袜

			'https://www.tujigu.com/x/75/', //推女郎   86
			// 'https://www.tujigu.com/x/75/index_#page.html', //推女郎
			
			'https://www.tujigu.com/x/74/', //美媛馆    464
			// 'https://www.tujigu.com/x/74/index_#page.html', //美媛馆

			'https://www.tujigu.com/x/73/', //尤物馆   169
			// 'https://www.tujigu.com/x/73/index_#page.html', //尤物馆

			'https://www.tujigu.com/x/72/', //MiStar魅妍社    324
			// 'https://www.tujigu.com/x/72/index_#page.html', //MiStar魅妍社

			'https://www.tujigu.com/x/71/', //MiiTao蜜桃社   141
			// 'https://www.tujigu.com/x/71/index_#page.html', //MiiTao蜜桃社

			'https://www.tujigu.com/x/70/', //MFStar模范学院  427
			// 'https://www.tujigu.com/x/70/index_#page.html', //MFStar模范学院

			'https://www.tujigu.com/x/69/', //LeYuan星乐园   46
			// 'https://www.tujigu.com/x/69/index_#page.html', //LeYuan星乐园
			
			'https://www.tujigu.com/x/68/', //IMiss爱蜜社   533
			// 'https://www.tujigu.com/x/68/index_#page.html', //IMiss爱蜜社

			'https://www.tujigu.com/x/67/', //FEILIN嗲囡囡   268
			// 'https://www.tujigu.com/x/67/index_#page.html', //FEILIN嗲囡囡

			'https://www.tujigu.com/x/66/', //波萝社   254
			// 'https://www.tujigu.com/x/66/index_#page.html', //波萝社

			'https://www.tujigu.com/x/65/', //misty    353  日本
			// 'https://www.tujigu.com/x/65/index_#page.html', //misty

			'https://www.tujigu.com/x/64/', //Wanibooks   152  日本
			// 'https://www.tujigu.com/x/64/index_#page.html', //Wanibooks

			'https://www.tujigu.com/x/63/', //尤果网    472
			// 'https://www.tujigu.com/x/63/index_#page.html', //尤果网
  
			'https://www.tujigu.com/x/62/', //尤果圈爱尤物   2011  ---- done
			// 'https://www.tujigu.com/x/62/index_#page.html', //尤果圈爱尤物

			'https://www.tujigu.com/x/61/', //影私荟      22

			'https://www.tujigu.com/x/60/', //TASTE顽味生活    30

			'https://www.tujigu.com/x/59/', //秀人网  2923 
			// 'https://www.tujigu.com/x/59/index_#page.html', //秀人网

			'https://www.tujigu.com/x/58/', //YOUMI尤蜜荟    621
			// 'https://www.tujigu.com/x/58/index_#page.html', //YOUMI尤蜜荟

			'https://www.tujigu.com/x/57/', //台湾Beautyleg     1832
			// 'https://www.tujigu.com/x/57/index_#page.html', //台湾Beautyleg

			'https://www.tujigu.com/x/56/', //UXING优星馆    59
			// 'https://www.tujigu.com/x/56/index_#page.html', //UXING优星馆

			'https://www.tujigu.com/x/55/', //御女郎DKGirl  148
			// 'https://www.tujigu.com/x/55/index_#page.html', //御女郎DKGirl

			'https://www.tujigu.com/x/54/', //NS Eyes  538  日本
			// 'https://www.tujigu.com/x/54/index_#page.html', //NS Eyes

			'https://www.tujigu.com/x/53/', //Image.tv  459  日本
			// 'https://www.tujigu.com/x/53/index_#page.html', //Image.tv

			'https://www.tujigu.com/x/52/', //YS Web    610  日本
			// 'https://www.tujigu.com/x/52/index_#page.html', //YS Web

			// ---- 'https://www.tujigu.com/x/51/', //H!P Digital Books   197  日本
			// ---- 'https://www.tujigu.com/x/51/index_#page.html', //H!P Digital Books

			// ---- 'https://www.tujigu.com/x/50/', //Bomb.TV   571   日本
			// ----- 'https://www.tujigu.com/x/50/index_#page.html', //Bomb.TV

			'https://www.tujigu.com/x/49/', //LIGUI丽柜   1425
			// 'https://www.tujigu.com/x/49/index_#page.html', //LIGUI丽柜

			'https://www.tujigu.com/x/48/', //PB写真集  298  日本
			// 'https://www.tujigu.com/x/48/index_#page.html', //PB写真集

			'https://www.tujigu.com/x/47/', //4K-STAR   350  日本
			// 'https://www.tujigu.com/x/47/index_#page.html', //4K-STAR

			'https://www.tujigu.com/x/46/', //ISHOW爱秀   187
			// 'https://www.tujigu.com/x/46/index_#page.html', //ISHOW爱秀

			'https://www.tujigu.com/x/45/', //头条女神   701
			// 'https://www.tujigu.com/x/45/index_#page.html', //头条女神

			'https://www.tujigu.com/x/44/', //动感之星  271
			// 'https://www.tujigu.com/x/44/index_#page.html', //动感之星

			'https://www.tujigu.com/x/43/', //Graphis   676  日本
			// 'https://www.tujigu.com/x/43/index_#page.html', //Graphis

			'https://www.tujigu.com/x/42/', //Bejean On Line  326 日本
			// 'https://www.tujigu.com/x/42/index_#page.html', //Bejean On Line

			'https://www.tujigu.com/x/41/', //51MODO  13

			'https://www.tujigu.com/x/40/', //Imuto.tv  45  日本
			// 'https://www.tujigu.com/x/40/index_#page.html', //Imuto.tv

			'https://www.tujigu.com/x/39/', //推女神  482
			// 'https://www.tujigu.com/x/39/index_#page.html', //推女神

			'https://www.tujigu.com/x/38/', //DDY Pantyhose  25

			'https://www.tujigu.com/x/37/', //爱丝   123
			// 'https://www.tujigu.com/x/37/index_#page.html', //爱丝

			'https://www.tujigu.com/x/36/', //VYJ   68  日本
			// 'https://www.tujigu.com/x/36/index_#page.html', //VYJ

			// ---- 'https://www.tujigu.com/x/35/', //Minisuka.tv    1263 ??? 日本 高中生为主
			// ---- 'https://www.tujigu.com/x/35/index_#page.html', //Minisuka.tv

			'https://www.tujigu.com/x/34/', //网红馆  81
			// 'https://www.tujigu.com/x/34/index_#page.html', //网红馆

			'https://www.tujigu.com/x/33/', //WPB写真   242  日本
			// 'https://www.tujigu.com/x/33/index_#page.html', //WPB写真

			'https://www.tujigu.com/x/32/', //美腿宝贝   31

			'https://www.tujigu.com/x/31/', //克拉女神   568
			// 'https://www.tujigu.com/x/31/index_#page.html', //克拉女神

			'https://www.tujigu.com/x/30/', //瑞丝馆   87
			// 'https://www.tujigu.com/x/30/index_#page.html', //瑞丝馆

			'https://www.tujigu.com/x/29/', //薄荷叶  5

			'https://www.tujigu.com/x/28/', //Sabra   321   日本
			// 'https://www.tujigu.com/x/28/index_#page.html', //Sabra

			'https://www.tujigu.com/x/27/', //果团网   164
			// 'https://www.tujigu.com/x/27/index_#page.html', //果团网

			'https://www.tujigu.com/x/26/', //青豆客  126
			// 'https://www.tujigu.com/x/26/index_#page.html', //青豆客

			'https://www.tujigu.com/x/25/', //花の颜  74
			// 'https://www.tujigu.com/x/25/index_#page.html', //花の颜

			'https://www.tujigu.com/x/24/', //模特联盟  3

			'https://www.tujigu.com/x/23/', //花漾   343
			// 'https://www.tujigu.com/x/23/index_#page.html', //花漾

			'https://www.tujigu.com/x/22/', //兔几盟  4

			'https://www.tujigu.com/x/21/', //Juicy Honey  133  日本
			// 'https://www.tujigu.com/x/21/index_#page.html', //Juicy Honey

			'https://www.tujigu.com/x/20/', //X-City   341
			// 'https://www.tujigu.com/x/20/index_#page.html', //X-City  日本

			'https://www.tujigu.com/x/19/', //Princess Collection  57 日本
			// 'https://www.tujigu.com/x/19/index_#page.html', //Princess Collection
        ),
		'start_page_num' => 1,
    ),
);


require_once '../bootstrap.inc.php';

set_time_limit(0);
ini_set('memory_limit','2048M');
ini_set('display_errors', 1);
error_reporting(E_ALL & ~E_NOTICE & ~E_WARNING);

###################### Define variables ################

$max_urls_per_source = isset($argv[1]) ? (int)$argv[1] : null;
$max_urls_per_source = empty($max_urls_per_source) ? 500 : $max_urls_per_source;

$prod_api = Config::get('prod_api_url');
$site_name = Config::get('theme');
$default_start_page = 1;
$existed_files = 0;
$total_parsed_urls = 0;

###################### End of define variables ################



###################### Define functions ################
function file_db_exist($url) {
	$res = File::getFileBySourceUrl($url);

	if(!$res) {
		$res = File::getIgnoredFileBySourceUrl($url);
	}

	return !empty($res);
}

function get_file_links_in_page($link, $page_number, $key_class_name, $keywords_of_file_link, $file_urls) {
	global $max_urls_per_source, $existed_files, $total_parsed_urls;
	$link = str_replace('#page', $page_number, $link);
	echo "... processing page: $link ... \n";
	$url_info = parse_url($link);
	$content = curl_call($link);
	$dom = new DOMDocument();
	@$dom->loadHTML($content);
	$finder = new DomXPath($dom);
	$elements = $finder->query("//*[contains(@class, '$key_class_name')]");
	foreach ($elements as $element) {
		foreach($element->getElementsByTagName('a') as $link) {
			foreach($link->attributes as $attr) {
				if($attr->name == 'href' && stristr($attr->value, $keywords_of_file_link)!==false) {
					if(stripos($attr->value, 'http') === 0) {
						$s_url = $attr->value;
					}
					else {
						$s_url = $url_info['scheme'] . '://'. $url_info['host'] . $attr->value;
					}
					if(!file_db_exist($s_url)) {
						array_push($file_urls ,$s_url);
						$file_urls = array_unique($file_urls);
						if(count($file_urls) >= $max_urls_per_source) {
							break 3;
						}
					}
					else {
						$existed_files++;
					}
					$total_parsed_urls++;
				}
			}
		}
	}
	return $file_urls;
}
###################### end of define functions ################


$mailMsg = '';

$m  = "#####################################\n";
$m .= date('Y-m-d H:i:s') . ' - ' . "Start importing files .... \n";
$m .= date('Y-m-d H:i:s') . ' - ' . "-- on " . Config::get('theme') . " \n";
$m .= "#####################################\n";
echo $m;
$mailMsg .= $m;

$tmp_num_file = '/tmp/z_import_jw-lastest-page-num-2';
$latest_page_numbers = (array)json_decode(file_get_contents($tmp_num_file));
$latest_page_nums = array();

$urls = array();
// Get urls first
foreach ($sources as $source) {
	$urls_of_this_source = array();
	$latest_num = $latest_page_numbers[$s_key];
	$start_page = empty($latest_num) ? $source['start_page_num'] : $latest_num;
	$page_processed = 0;
	while(count($urls_of_this_source) < $max_urls_per_source) {
		shuffle($source['tag_links']);
		foreach($source['tag_links'] as $tag_link) {
			$urls_of_this_source = get_file_links_in_page($tag_link, $start_page, $source['key_class_name'], $source['keywords_of_file_link'], $urls_of_this_source);
			if(count($urls_of_this_source) >= $max_urls_per_source) {
				break 2;
			}
		}
		$start_page++;
		$page_processed++;
		if($page_processed > 2) {
			break 1;
		}
	}

	$latest_page_nums[$s_key] = $start_page;

	$urls = array_merge($urls, $urls_of_this_source);
}

file_put_contents($tmp_num_file, json_encode($latest_page_nums));

shuffle($urls);

$m  = "-----------------------------------\n";
$m .= date('Y-m-d H:i:s') . ' - ' . 'Total url parsed: ' . $total_parsed_urls . ', existed_files: ' . $existed_files . ", finial get urls: ". count($urls) ."\n";
$m .=  "-----------------------------------\n";
echo $m;
$mailMsg .= $m;

// Start importing to current (dev) site: getting contents of file page and parsing and saving
$i = 1;
$success = 0;
$failed = 0;
foreach ($urls as $url) {
	echo date('Y-m-d H:i:s') . ' - ' . "$i - importing: $url \n";

	// call xparser server
    $api_server = Config::get('api_server');
    $imv_url = $api_server . '?ac=import_file&url=' . urlencode($url);
    echo date('Y-m-d H:i:s') . ' - ' . "calling: $imv_url \n";
	$res = json_decode(curl_call($imv_url));
	echo date('Y-m-d H:i:s') . ' - ' . "---- status: ".$res->status.", msg: ".$res->msg." \n\n";
	if($res->status) {
		$success++;
	}
	else {
		$failed++;
	}
	$i++;
}

$m = date('Y-m-d H:i:s') . ' - ' . "In local totally have " . ($i-1) . " files, successfully imported $success, failed $failed \n\n";
echo $m;
$mailMsg .= $m;

// Sync to prod files table
// $m = date('Y-m-d H:i:s') . ' - ' . "Start to sync new files to prod...\n";
// echo $m;
// $mailMsg .= $m;
// $max_file_id_local = File::getMaxFileId();
// $max_file_id_prod = curl_call($prod_api . '?ac=get_max_file_id');
// $m = date('Y-m-d H:i:s') . ' - ' . "Local max file id = $max_file_id_local, prod max file id = $max_file_id_prod\n";
// echo $m;
// $mailMsg .= $m;
// $i = 0;
// $success = 0;
// $failed = 0;
// if($max_file_id_prod < $max_file_id_local) {
// 	$sql = 'select * from '.Config::get('db_table_prefix').'files where id > ' . $max_file_id_prod;
// 	$res = DB::$dbInstance->getRows($sql);
// 	foreach ($res as $fileObj) {
// 		$i++;
// 		$res2 = curl_call($prod_api.'?ac=save_file_data_and_node', 'post', array('obj'=>json_encode($fileObj)));
// 		$res2 == '1' ? $success++ : $failed++;
// 		$result = $res2?'1':'0';

//         $m = date('Y-m-d H:i:s') . ' - ' . "$i - sync to prod: ".$fileObj['source_url']." -- $result\n";
//         echo $m;
//         $mailMsg .= $m;
// 	}
// }

// $m  = "-----------------------------------\n";
// $m .= date('Y-m-d H:i:s') . ' - ' . "Totally syncing $i files, success $success, failed $failed \n";
// $m .= "-----------------------------------\n\n";
// echo $m;
// $mailMsg .= $m;

// mail("elevenfox11@gmail.com","$site_name import files", $mailMsg);

