<?php

$dirs = <<<EOF
御女郎_Annie安妮《玲珑美人》-Vol.084-写真集-49P-
御女郎_Annie安妮《美乳翘臀下修长玉腿异常诱人》-Vol.096-写真集-48P-
御女郎_Annie安妮《美胸翘臀下的修长玉腿》-Vol.091-写真集-53P-
御女郎_K8傲娇萌萌Vivian《泳装-高叉-湿身》-Vol.011-写真集-46P-
御女郎_Meow喵喵哒《圣诞写真特辑》-VOL.008-写真集-50P-
御女郎_Meow喵喵哒《地铁写真特辑》-VOL.023-写真集-53P-
御女郎_Sugar梁莹《诱人激凸、情迷红酒诱惑、情趣内衣》-VOL.007-写真集-47P-
御女郎_Sukki《丰乳肥臀绝美火辣身材》-Vol.053-写真集-52P-
御女郎_Sukki《丰乳肥臀绝美诱惑》-Vol.042-写真集-46P-
御女郎_Ting婷婷《172长腿美人，户外大尺度露出》-Vol.038-写真集-31P-
御女郎_Ting婷婷《美乳美臀美腿魅力诱惑》-Vol.062-写真集-51P-
御女郎_UU阿文《激凸、湿身精彩尺度诱惑》-VOL.009-写真集-46P-
御女郎_丁筱南《旗袍-性感礼服-丁字裤》-VOL.004-写真集-49P-
御女郎_仓井优香《低涌之夏主题》-VOL.051-写真集-57P-
御女郎_仓井优香《户外露出清新养眼》-Vol.090-写真集-50P-
御女郎_仓井优香《户外露出狂野》-Vol.076-写真集-61P-
御女郎_仓井优香《甜美童颜下美乳翘臀》-Vol.085-写真集-49P-
御女郎_仓井优香《真空演绎湿身诱惑》-VOL.046-写真集-41P-
御女郎_仓井优香《神似苍老师的日系美女》-VOL.027-写真集-57P-
御女郎_仓井优香《童颜美乳，日系清纯少女，户外露出》-Vol.039-写真集-49P-
御女郎_仓井优香《美乳童颜少女》-Vol.066-写真集-52P-
御女郎_仓井优香《运动特辑》-VOL.033-写真集-50P-
御女郎_仓井优香《青春无敌气息的美乳童颜少女》-Vol.071-写真集-43P-
御女郎_仓井优香《青春无敌，美乳美臀》-VOL.029-写真集-47P-
御女郎_健身美人-媛美人-Vol.043-写真集-49P-
御女郎_冰冰儿《秀丽美腿与丰乳美臀》-Vol.103-写真集-48P-
御女郎_冰冰儿《秀丽美腿与美臀》-Vol.089-写真集-52P-
御女郎_冰冰儿《精致内衣下秀丽美腿与丰乳美臀》-Vol.098-写真集-46P-
御女郎_厉雯娜《性感轻熟女》-VOL.044-写真集-44P-
御女郎_啊宝宝《纯情少女，丰乳肥臀》-VOL.025-写真集-53P-
御女郎_夏妍《巨乳肥臀，风情万种撩人心魄》-Vol.037-写真集-54P-
御女郎_夏小秋秋秋《黑丝美腿诱惑与真空内衣尺度福利》-VOL.020-写真集-46P-
御女郎_夏雨涵《熟女知性，巨乳丰臀》-VOL.002-写真集-43P-
御女郎_夏雨涵、韩恩熙《双人拉拉》-VOL.022-写真集-40P-
御女郎_婕西儿jessie《巨乳丽人羊城夜景露出》-Vol.059-写真集-49P-
御女郎_婕西儿jessie《巨乳高挑，性感狂野》-VOL.030-写真集-48P-
御女郎_婕西儿jessie《浴室比基尼，外景露出和新春主题》-VOL.010-写真集-48P-
御女郎_媛美人《工装出动性感狂野》-Vol.077-写真集-50P-
御女郎_媛美人《甜美佳人，丰乳肥臀，真空演绎民国风》-Vol.052-写真集-51P-
御女郎_媛美人《甜美校服系列-情趣SM内衣》-Vol.061-写真集-48P-
御女郎_完美美女-蔡乐儿《日韩式性感，青春逼人》-VOL.024-写真集-52P-
御女郎_小子怡Alice《大胆丝袜外拍》-Vol.114-写真集-47P-
御女郎_小子怡Alice《室外泳池内衣湿身系列》-Vol.117-写真集-31P-
御女郎_小子怡Alice《泳池系列》-Vol.119-写真集-22P-
御女郎_岑雨桥《巨乳童颜，浴室湿身，丝袜美腿诱惑》-VOL.017-写真集-54P-
御女郎_岑雨桥《混血美人，童颜巨乳》-VOL.031-写真集-53P-
御女郎_岑雨桥《粉红圣诞主题系列》-VOL.003-写真集-53P-
御女郎_张花花《皮草网袜熟女》-Vol.118-写真集-40P-
御女郎_性感尤物-丁筱南《巨乳美腿，风姿绰约妩媚动人》-VOL.015-写真集-41P-
御女郎_性感御姐-筱慧icon《美乳美腿性感撩人》-Vol.073-写真集-47P-
御女郎_日系清纯美女-苍井优香《湿身海岸露出》-Vol.058-写真集-49P-
御女郎_李可可《巨乳美腿，真空演绎》-Vol.063-写真集-51P-
御女郎_李可可《秘书OL的惹火魅惑》-Vol.080-写真集-49P-
御女郎_李可可《童颜巨乳，F乳真空演绎》-Vol.070-写真集-46P-
御女郎_桃子marry《韵味镂空旗袍与诱惑蕾丝内衣》-Vol.093-写真集-46P-
御女郎_梅哥《真空演绎美乳美臀诱惑》-VOL.047-写真集-53P-
御女郎_梅哥《真空演绎美颜美乳美腿翘臀》-Vol.056-写真集-50P-
御女郎_梅哥《美乳美臀美腿的诱惑》-Vol.067-写真集-44P-
御女郎_梦倩《巨乳风情诱惑》-VOL.050-写真集-39P-
御女郎_梦倩《美腿巨乳，性感诱人》-VOL.034-写真集-37P-
御女郎_梦倩《美腿美乳精彩诱惑》-Vol.057-写真集-42P-
御女郎_模特梅哥《清新可人，美乳美腿，时尚性感》-VOL.026-写真集-58P-
御女郎_模特红艳《高颜值巨乳丰臀》-VOL.035-写真集-51P-
御女郎_欧尼anne《性感黑丝美腿，诱惑湿身激凸》-VOL.014-写真集-34P-
御女郎_欧尼anne《清新秀丽，无敌美腿女神》-VOL.006-写真集-46P-
御女郎_混血演员-安娜金《巨乳丰臀诱惑无限》-VOL.021-写真集-37P-
御女郎_潘琳琳ber《丰满巨乳》-Vol.116-写真集-43P-
御女郎_潘琳琳ber《巨乳毛衣尤物》-Vol.113-写真集-43P-
御女郎_潘琳琳ber《性感学生装制服诱惑》-Vol.110-写真集-50P-
御女郎_潘琳琳ber《性感空乘制服诱惑》-Vol.107-写真集-53P-
御女郎_王婉悠Queen《浴室丰乳肥臀》-Vol.064-写真集-47P-
御女郎_王沫儿SaSa《圣诞特辑》-VOL.005-写真集-52P-
御女郎_王沫儿SaSa《激情写真》-VOL.016-写真集-51P-
御女郎_筱慧cindy《性感枪械COS系列》-Vol.104-写真集-50P-
御女郎_纯美少女-萌宝儿BoA《COS特辑》-Vol.036-写真集-51P-
御女郎_《美貌双妹户外露出，拉拉激情视觉诱惑》-VOL.049-写真集-48P-
御女郎_艾小青《丝袜美腿系列，真空演绎》-Vol.105-写真集-44P-
御女郎_艾小青《，妖艳白狐外拍系列，真空演绎》-Vol.099-写真集-49P-
御女郎_艾小青《户外车拍丝袜美腿》-Vol.088-写真集-51P-
御女郎_艾小青《户外露天拍摄系列，真空演绎》-Vol.108-写真集-48P-
御女郎_艾小青《浴池高叉尤物》-Vol.115-写真集-48P-
御女郎_艾小青《真空演绎，狂野妖娆》-Vol.120-写真集-45P-
御女郎_艾小青《红发女郎COS》-Vol.112-写真集-50P-
御女郎_艾小青《黑丝美腿外拍系列》-Vol.102-写真集-38P-
御女郎_艾小青《黑丝美腿，真空户外露出》-Vol.092-写真集-40P-
御女郎_艾小青《黑丝美腿，真空户外露出》-Vol.097-写真集-10P-
御女郎_苍井优香《清纯甜美草帽少女》-Vol.055-写真集-53P-
御女郎_萌宝儿BoA《守望先锋Dva特辑》-Vol.081-写真集-46P-
御女郎_萌宝儿BoA《巨乳童颜演俏皮性感服饰》-Vol.106-写真集-53P-
御女郎_萌宝儿BoA《巨乳童颜演绎最萌武装》-Vol.082-写真集-46P-
御女郎_萌宝儿BoA《浴室黑丝湿身》-VOL.013-写真集-42P-
御女郎_萌宝儿BoA《海岛户外露出》-Vol.054-写真集-50P-
御女郎_萌宝儿BoA《真空演绎丰乳肥臀与黑丝美腿诱惑》-Vol.111-写真集-48P-
御女郎_萌宝儿BoA《纯美高颜值美女》-VOL.045-写真集-55P-
御女郎_萌宝儿BoA《贴心女仆私房诱惑》-Vol.087-写真集-49P-
御女郎_萌宝儿BoA《贴心女仆私房诱惑》-Vol.094-写真集-37P-
御女郎_萌宝儿BoA《销魂酥胸，性感翘臀》-VOL.001-写真集-49P-
御女郎_萌宝儿BoA《青春纯美与荒野海边户外露出》-Vol.074-写真集-50P-
御女郎_萌宝儿BoA《黑白不同的诱人内衣美轮美奂》-Vol.100-写真集-50P-
御女郎_萌汉药baby《巨乳肥臀视觉冲击》-Vol.079-写真集-49P-
御女郎_萌汉药baby《惹火姿势性感撩人》-Vol.069-写真集-53P-
御女郎_蔡乐儿《吃鸡特辑》-Vol.065-写真集-49P-
御女郎_蔡乐儿《美胸美腿，修长丝足》-VOL.018-写真集-57P-
御女郎_邝凯欣bbbbaby《丰乳肥臀，温柔秀美》-VOL.028-写真集-49P-
御女郎_雪儿Cier《情趣皮衣制服系列，超诱惑的丰乳肥臀》-Vol.109-写真集-48P-
御女郎_雪儿Cier《艳艳动人甜美少妇》-Vol.086-写真集-46P-
御女郎_雪儿Cier《艳艳动人甜美少妇》-Vol.095-写真集-40P-
御女郎_雪儿Cier《超诱惑的丰乳肥臀》-Vol.101-写真集-47P-
御女郎_雪千寻-amp-amp-amp-雪千紫《丰乳肥臀姐妹花的诱惑》-Vol.040-写真集-49P-
御女郎_雪千寻《妖媚熟女，巨乳肥臀》-VOL.048-写真集-47P-
御女郎_雪千寻《成熟少妇，丰乳肥臀》-Vol.083-写真集-48P-
御女郎_雪千寻《知性少妇，丰乳肥臀，丝腿SM》-VOL.032-写真集-52P-
御女郎_雪千寻《风骚少妇，丰乳肥臀》-Vol.075-写真集-54P-
御女郎_韩恩熙《激凸真空的迷人巨乳》-Vol.012-写真集-45P-
御女郎_高颜值美女-叶佳颐-VOL.019-写真集-56P-
御女郎_高颜值美女-啊宝宝《蕾丝内衣-兔女郎》-Vol.041-写真集-54P-
EOF;

// 重命名文件夹用tujigu的名字，copy desc 和 tags，重命名thumbnail
if (!function_exists('str_starts_with')) {
    function str_starts_with($haystack, $needle) {
        return (string)$needle !== '' && strncmp($haystack, $needle, strlen($needle)) === 0;
    }
}

function find_between($str, $startDelimiter, $endDelimiter) {
    $contents = array();
    $startDelimiterLength = strlen($startDelimiter);
    $endDelimiterLength = strlen($endDelimiter);
    $startFrom = $contentStart = $contentEnd = 0;
    while (false !== ($contentStart = strpos($str, $startDelimiter, $startFrom))) {
      $contentStart += $startDelimiterLength;
      $contentEnd = strpos($str, $endDelimiter, $contentStart);
      if (false === $contentEnd) {
        break;
      }
      $contents[] = substr($str, $contentStart, $contentEnd - $contentStart);
      $startFrom = $contentEnd + $endDelimiterLength;
    }
  
    return $contents;
}

$folder_full_path = isset($argv[1]) ? $argv[1] : null;

if(empty($folder_full_path)) {
    echo "---- Must have a full folder path as the param! \n";
    exit;
}

$dryrun = 0;
$org_name = '御女郎';
$org_name_en = 'DKGirl';

$scan = scandir($folder_full_path);
foreach($scan as $folder_name) {
   if (is_dir("$folder_full_path/$folder_name") && $folder_name!='.' && $folder_name!='..') {
        $the_full_path = "$folder_full_path/$folder_name";
        echo "------------------------- \n";
        echo "-- Current folder: $folder_name \n";
        // Get cuurent folder vol number
        $l_folder_name = strtolower($folder_name);
        //$v_arr = explode(' ',$l_folder_name);
        $v_arr = explode('-',$l_folder_name);
        $vol = $v_arr[1];

        $vol = str_replace('vol.', '', $vol);
        // Go to origin path to get folder name with the same vol num
        $origin = getOriginFolderByVol($vol);
        echo print_r($origin,1) . "\n"; 
        
        if(!empty($origin)) {
            // copy desc.txt and tags.txt from origin folder
            $desc_str = file_get_contents($origin['full_path'] . "/desc.txt");
            $desc_str = str_replace(' 生日','生日', $desc_str);
            $pos = strpos($desc_str, '生日');
            if($pos !== false) {
                $c = $desc_str[$pos-1];
                if ($c != "\n" && $c != "\rn" && $c != "\r") {
                    $desc_str = str_replace('生日',"\n生日", $desc_str);
                }
            }
            $desc_str = str_replace(' 罩杯','罩杯', $desc_str);
            $pos = strpos($desc_str, '罩杯');
            if($pos !== false) {
                $c = $desc_str[$pos-1];
                if ($c != "\n" && $c != "\rn" && $c != "\r") {
                    $desc_str = str_replace('罩杯',"\n罩杯", $desc_str);
                }
            }
            echo "Processing " . $the_full_path . "/desc.txt \n";
            if(!$dryrun) file_put_contents($the_full_path.'/desc.txt', $desc_str);
            
            // copy($origin['full_path'] . "/tags.txt", $the_full_path . "/tags.txt");

            // Gen new tags
            $tags_str = file_get_contents($origin['full_path'] . "/tags.txt");
            $tags = explode(',', $tags_str);
            if(! in_array($org_name_en, $tags) && ! in_array(strtolower($org_name_en), $tags)) {
                $tags[] = $org_name_en;
            }
            if(! in_array( $org_name, $tags ) ) {
                $tags[] = $org_name;
            }
            if(! in_array( $origin['model'], $tags ) ) {
                $tags[] = $origin['model'];
            }
            $new_tags_str = implode(',', $tags);
            $new_tags_str = str_replace(strtolower($org_name_en), $org_name_en, $new_tags_str);
            echo "---- New tags: $new_tags_str \n";
            // create tags.txt
            echo "file_put_contents($the_full_path/tags.txt, $new_tags_str) \n";
            // if(!$dryrun) file_put_contents($the_full_path.'/tags.txt', $new_tags_str);

            // create a new empty dl.txt in current folder
            echo "file_put_contents($the_full_path/dl.txt, '') \n";
            if(!$dryrun) file_put_contents($the_full_path.'/dl.txt', '');

            // If no thumbnail.jpg, rename last image to thumbnail.jpg
            $scan2 = scandir($the_full_path);
            $images = [];
            $already_has_thumbnail = false;
            foreach($scan2 as $file) {
                $origin_file_full = $the_full_path . '/' . $file;
                if($file == 'thumbnail.jpg') $already_has_thumbnail = true;
                if ( is_file($origin_file_full) && @is_array(getimagesize($origin_file_full)) ) {
                    $images[] = $file;
                }
            }
            if((int)$vol < 37) {
                $thumb = $images[0];
            }
            else {
                $thumb = $images[count($images) - 1];
            }
            if($already_has_thumbnail) {
                echo "---- Already has a thumbnail.jpg \n\n";
            }
            else {
                // echo 'rename('. $the_full_path . '/' . $thumb . ', ' . $the_full_path . '/thumbnail.jpg' .  "\n\n";
                // if(!$dryrun) rename($the_full_path . '/' . $thumb , $the_full_path . '/thumbnail.jpg');    
            }

            // rename current folder to the origin folder name
            // echo "rename $the_full_path to $folder_full_path/".$org_name_en.$org_name."-". $vol. '-'. $origin['main'] . "\n\n";
            // if(!$dryrun) rename($the_full_path, $folder_full_path . '/'.$org_name_en.$org_name.'-' . $vol. '-'. $origin['main']);
        }
   }
}



function getOriginFolderByVol($vol_num) {
    // $vol_num = '第' . (int)$vol_num . '期';
    // echo "vol_num = $vol_num \n";
    
    $origin_folders = '/mnt/nas/jw-photos/tujigu/御女郎';
    // $scan = scandir($origin_folders);
    global $dirs;
    $scan = explode("\r\n", $dirs);

    $folder_info = [];
    
    foreach($scan as $folder_name) {      
        // echo "folder: $folder_name \n";  
        if (is_dir("$origin_folders/$folder_name") && $folder_name!='.' && $folder_name!='..') {
            $l_folder_name = strtolower($folder_name);
            // echo "l_folder: $l_folder_name \n";
            
            if(strpos($l_folder_name, $vol_num) !== false) {
                $l_folder_name = str_replace('《','-',$l_folder_name);
                $l_folder_name = str_replace('》','-',$l_folder_name);
                $l_folder_name = str_replace('_-','_',$l_folder_name);
                $l_folder_name = str_replace('---','-',$l_folder_name);
                $l_folder_name = str_replace('--','-',$l_folder_name);
                $folder_info['name'] = $l_folder_name;
                $folder_info['full_path'] = $origin_folders  . '/' . $folder_name;

                $tt = find_between($l_folder_name, '御女郎_', '-');
                if(str_starts_with($tt[0], 'vol.')) {
                    $ss = explode('-', $l_folder_name);
                    $folder_info['model'] = $ss[1];
                    $yy = find_between($l_folder_name, '-', 'p-');
                    $main_arr = explode('-', $yy[0]);
                    array_pop($main_arr);
                    $main = implode('-', $main_arr);
                    $folder_info['main'] = $main;
                }
                else {
                    $folder_info['model'] = $tt[0];
                    $yy = find_between($l_folder_name, '御女郎_', '-vol');
                    $main = trim($yy[0], '-');
                    $folder_info['main'] = $main;
                }
            }
        }
    }

    return $folder_info;
}